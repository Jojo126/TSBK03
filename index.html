<html>
	<head>
		<title>Cloth simulation</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<script src="js/three.js"></script>
		<script>
            
			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );
            camera.position.z = 5;

			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );
            
            // Objects in scene
            const WIDTHVERTICES = 7;
            const HEIGHTVERTICES = 9;
            var geometry = new THREE.PlaneBufferGeometry( 3, 3, WIDTHVERTICES, HEIGHTVERTICES );
            var planeVertices = geometry.getAttribute('position');
            geometry.userData.oldPosition = planeVertices;
            
            
            var material = new THREE.MeshBasicMaterial( {color: 0xffff00, side: THREE.DoubleSide, wireframe: true} );
            var plane = new THREE.Mesh( geometry, material );
            scene.add( plane );
            
			//console.log(geometry.userData.oldPosition.array);
            //console.log(planeVertices.array);
            
            const gravity = 9.8;
            const mass = 0.01;
            const springConstant = 0.2;
            let timestep = 1/30;
            
            
            // Render-loop
			var animate = function () {
				requestAnimationFrame( animate );
                
                // Updating vertices position
                geometry.attributes.position.needsUpdate = true;
                for (let i = 0; i < planeVertices.count; i += 1) {
                    
                    let springForceX = 0;
                    let springForceY = 0;
                    let springForceZ = 0;
                    
                    if(!(i === 0 || i === WIDTHVERTICES)) //Suspended corners
                    {
                        //Structural springs
                        if(i > WIDTHVERTICES) //if not first row
                        {
                            springForceX += springConstant*(planeVertices.getX(i-WIDTHVERTICES-1)-planeVertices.getX(i));
                            springForceY += springConstant*(planeVertices.getY(i-WIDTHVERTICES-1)-planeVertices.getY(i));
                            springForceZ += springConstant*(planeVertices.getZ(i-WIDTHVERTICES-1)-planeVertices.getZ(i));
                            
                        }
                        if(i < (WIDTHVERTICES+1)*HEIGHTVERTICES) //if not last row
                        {
                            springForceX += springConstant*(planeVertices.getX(i+WIDTHVERTICES+1)-planeVertices.getX(i));
                            springForceY += springConstant*(planeVertices.getY(i+WIDTHVERTICES+1)-planeVertices.getY(i));
                            springForceZ += springConstant*(planeVertices.getZ(i+WIDTHVERTICES+1)-planeVertices.getZ(i));
                            
                        }
                        if(i%(WIDTHVERTICES+1) !== 0) //if not first column
                        {
                            springForceX += springConstant*(planeVertices.getX(i-1)-planeVertices.getX(i));
                            springForceY += springConstant*(planeVertices.getY(i-1)-planeVertices.getY(i));
                            springForceZ += springConstant*(planeVertices.getZ(i-1)-planeVertices.getZ(i));
                            
                        }
                        if((i-WIDTHVERTICES)%(WIDTHVERTICES+1) !== 0) //if not last column
                        {
                            springForceX += springConstant*(planeVertices.getX(i+1)-planeVertices.getX(i));
                            springForceY += springConstant*(planeVertices.getY(i+1)-planeVertices.getY(i));
                            springForceZ += springConstant*(planeVertices.getZ(i+1)-planeVertices.getZ(i));
                            
                        }
                        
                        //Shear springs
                        if(i > WIDTHVERTICES && i%(WIDTHVERTICES+1) !== 0) //if not first row and not first column
                        {
                            springForceX += springConstant*(planeVertices.getX(i-WIDTHVERTICES-2)-planeVertices.getX(i));
                            springForceY += springConstant*(planeVertices.getY(i-WIDTHVERTICES-2)-planeVertices.getY(i));
                            springForceZ += springConstant*(planeVertices.getZ(i-WIDTHVERTICES-2)-planeVertices.getZ(i));
                            
                        }
                        if(i > WIDTHVERTICES && (i-WIDTHVERTICES)%(WIDTHVERTICES+1) !== 0) //if not first row and not last column
                        {
                            springForceX += springConstant*(planeVertices.getX(i-WIDTHVERTICES)-planeVertices.getX(i));
                            springForceY += springConstant*(planeVertices.getY(i-WIDTHVERTICES)-planeVertices.getY(i));
                            springForceZ += springConstant*(planeVertices.getZ(i-WIDTHVERTICES)-planeVertices.getZ(i));
                            
                        }
                        if(i < (WIDTHVERTICES+1)*HEIGHTVERTICES && i%(WIDTHVERTICES+1) !== 0) //if not last row and not first column
                        {
                            springForceX += springConstant*(planeVertices.getX(i+WIDTHVERTICES)-planeVertices.getX(i));
                            springForceY += springConstant*(planeVertices.getY(i+WIDTHVERTICES)-planeVertices.getY(i));
                            springForceZ += springConstant*(planeVertices.getZ(i+WIDTHVERTICES)-planeVertices.getZ(i));
                            
                        }
                        if(i < (WIDTHVERTICES+1)*HEIGHTVERTICES && (i-WIDTHVERTICES)%(WIDTHVERTICES+1) !== 0) //if not last row and not last column
                        {
                            springForceX += springConstant*(planeVertices.getX(i+WIDTHVERTICES+2)-planeVertices.getX(i));
                            springForceY += springConstant*(planeVertices.getY(i+WIDTHVERTICES+2)-planeVertices.getY(i));
                            springForceZ += springConstant*(planeVertices.getZ(i+WIDTHVERTICES+2)-planeVertices.getZ(i));
                            
                        }

                        
                        
                        //Update old position
                        geometry.userData.oldPosition.array = planeVertices.array; //For xyz at the same time
                        
                        //Update new position
                        let newPosX = 2*planeVertices.getX(i) - geometry.userData.oldPosition.getX(i) - Math.pow(timestep,2)*(-springForceX)/mass;
                        planeVertices.setX(i, newPosX);
                        let newPosY = 2*planeVertices.getY(i) - geometry.userData.oldPosition.getY(i) - Math.pow(timestep,2)*(gravity*mass-springForceY)/mass;
                        planeVertices.setY(i, newPosY);
                        let newPosZ = 2*planeVertices.getZ(i) - geometry.userData.oldPosition.getZ(i) - Math.pow(timestep,2)*(-springForceZ)/mass;
                        planeVertices.setZ(i, newPosZ);
                        
                        //geometry.userData.oldPosition.setY(i, planeVertices.getY(i));
                        
                        //console.log('oldPos: ' + geometry.userData.oldPosition.array);
                        //console.log('newPos: ' + planeVertices.array);
                    }
                }
                
				//plane.rotation.x += 0.01;
				plane.rotation.y += 0.01;

				renderer.render( scene, camera );
			};

			animate();
		</script>
	</body>
</html>